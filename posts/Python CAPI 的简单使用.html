<!DOCTYPE html><html><head>
      <title>Python CAPI 的简单使用</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  background-color: whitesmoke;
  color: dimgrey;
  /*Code blocks*/
  /*Preformatted text*/
  /*table*/
}
.markdown-preview.markdown-preview h1 {
  color: black;
}
.markdown-preview.markdown-preview h2,
.markdown-preview.markdown-preview h3,
.markdown-preview.markdown-preview h4,
.markdown-preview.markdown-preview h5,
.markdown-preview.markdown-preview h6 {
  color: dimgray;
}
.markdown-preview.markdown-preview code,
.markdown-preview.markdown-preview tt {
  color: cornflowerblue;
  white-space: nowrap;
}
.markdown-preview.markdown-preview pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}
.markdown-preview.markdown-preview .highlight pre {
  background-color: #f8f8f8;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}
.markdown-preview.markdown-preview pre {
  background-color: gainsboro;
  /*font-size:          13px;*/
  font-size: 0.9em !important;
  line-height: 1.6em !important;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}
.markdown-preview.markdown-preview pre code,
.markdown-preview.markdown-preview pre tt {
  background-color: transparent;
  border: none;
}
.markdown-preview.markdown-preview table {
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  text-align: center;
}
.markdown-preview.markdown-preview table tr {
  /* border-top: 1px solid #cccccc; */
  background-color: white;
  margin: 0;
  padding: 0;
}
.markdown-preview.markdown-preview table tr:nth-child(2n) {
  background-color: #f8f8f8;
}
.markdown-preview.markdown-preview table tr th {
  font-weight: bold;
  /* border: 0.5px solid #cccccc; */
  /* border-left: 0.5px solid #cccccc;
        border-right: 0.5px solid #cccccc; */
  background-color: #eefbff;
  font-size: 14px;
  margin: 0;
  padding: 0.4em 0.35em 0.4em 0.35em;
}
.markdown-preview.markdown-preview table tr td {
  /* border: 1px solid #cccccc; */
  margin: 0;
  font-size: 14px;
  padding: 5px 5px;
}
.markdown-preview.markdown-preview table tr th :first-child,
.markdown-preview.markdown-preview table tr td :first-child {
  margin-top: 0;
}
.markdown-preview.markdown-preview table tr th :last-child,
.markdown-preview.markdown-preview table tr td :last-child {
  margin-bottom: 0;
}
.md-sidebar-toc.md-sidebar-toc {
  color: dimgray;
}
.md-toc {
  color: dimgray;
}
.md-toc-link {
  color: dimgray;
}

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#python-capi-的简单使用" class="md-toc-link"><p>Python CAPI 的简单使用</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#环境配置" class="md-toc-link"><p>环境配置</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#编译环境" class="md-toc-link">
            <p>编译环境</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#docker-镜像封装" class="md-toc-link">
            <p>Docker 镜像封装</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#usage" class="md-toc-link"><p>Usage</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#引用头文件" class="md-toc-link">
            <p>引用头文件</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#常用函数" class="md-toc-link"><p>常用函数</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#初始化" class="md-toc-link">
            <p>初始化</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#线程相关" class="md-toc-link"><p>线程相关</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#gil" class="md-toc-link">
            <p>GIL</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#多线程" class="md-toc-link">
            <p>多线程</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#运行-python-脚本" class="md-toc-link">
            <p>运行 python 脚本</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#模块导入" class="md-toc-link">
            <p>模块导入</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#获取-py-脚本中的函数对象" class="md-toc-link">
            <p>获取 py 脚本中的函数对象</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#构建输入对象" class="md-toc-link">
            <p>构建输入对象</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#构建输出对象" class="md-toc-link">
            <p>构建输出对象</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#获取结果" class="md-toc-link">
            <p>获取结果</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#错误和异常处理" class="md-toc-link">
            <p>错误和异常处理</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#内存相关" class="md-toc-link"><p>内存相关</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#引用计数" class="md-toc-link">
            <p>引用计数</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#reference" class="md-toc-link">
            <p>Reference</p>

          </a></div>
        </div>
      </details>
    
</div>
<h1 id="python-capi-的简单使用">Python CAPI 的简单使用 </h1>
<p>之前开发一个模块，需要调用 Python 的 CAPI。主要功能是：在 cpp 编写的程序中，将数据转成 Py 对象 PyObject，传入 Python 脚本，再将返回值写回程序中。其实就是间接调用 python 脚本，有输入和输出。在这里做一下记录。<!-- more --></p>
<p>Python 版本：3.6<br>
clang 版本：3.4.2<br>
本机：MacOS<br>
本机 Python 头文件目录：<code>/XX/anaconda3/include/python3.6m</code>。<br>
安装 python 以后，在安装目录下的 include/python3.6m 中即可找到。</p>
<h2 id="环境配置">环境配置 </h2>
<p>如果想用自定义路径的 python：<code>export CPLUS_INCLUDE_PATH=/xxx/include/python3.7m/</code></p>
<ol>
<li>设置默认 python 路径，在~/.bashrc 中配置：</li>
</ol>
<pre data-role="codeBlock" data-info="Bash" class="language-bash Bash"><code><span class="token builtin class-name">alias</span> <span class="token assign-left variable">python2</span><span class="token operator">=</span><span class="token string">'/YourLib/bin/python2.7'</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">python3</span><span class="token operator">=</span><span class="token string">'/YourLib/bin/python3.6'</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">python</span><span class="token operator">=</span>python3
</code></pre><ol start="2">
<li>在<code>~/.bashrc</code> 中配置<code>unset python</code>：使用默认环境。</li>
</ol>
<h3 id="编译环境">编译环境 </h3>
<p>由于需要 python 的库，当使用 CMAKE 时，需要添加如下内容，其中，<code>${PROJECT_SOURCE_DIR}/your_path</code>就是 python 文件夹路径，可以用<code>sys</code>库找到具体位置：</p>
<pre data-role="codeBlock" data-info="cmake" class="language-cmake cmake"><code><span class="token keyword keyword-set">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_C_FLAGS</span> <span class="token string">"<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_C_FLAGS</span><span class="token punctuation">}</span></span> -I<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/your_path/python3.6/include/python3.6m -I /your_path/python3.6.include/python3.6m -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -03 -Wall -Wstrict-prototypes"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-set">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_EXE_LINKER_FLAGS</span> <span class="token string">"-L /your_path/python3.6/lib -L /your_path/python3.6/lib -lpython3.6m -lpthread -ldl -lutil -lm -Xlinker -export-dynamic"</span><span class="token punctuation">)</span>
<span class="token function">TARGET_LINK_LIBRARIES</span><span class="token punctuation">(</span>your_exe_file python3.6m<span class="token punctuation">)</span>
</code></pre><p>修改 bashrc，增加动态链接库路径<br>
<code>export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$JAVA_HOME/jre/lib/amd64/server:$HADOOP_HDFS_HOME/lib:/usr/lib:$MLF_TEST_DEP_HOME/crf++/lib:$MLF_TEST_DEP_HOME/python3.6/lib/</code></p>
<h3 id="docker-镜像封装">Docker 镜像封装 </h3>
<p>由于需要将可执行文件放到 docker 中，这一步骤也花费了一些时间。无此需求的盆友可以略过本小节。</p>
<pre data-role="codeBlock" data-info="DockerFile" class="language-dockerfile DockerFile"><code><span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> busybox:1.29.3</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> set -ex <span class="token operator">\</span>
  <span class="token operator">\</span>
  &amp;&amp; wget http://ftp.gnu.org/gnu/gcc/gcc-4.5.1/gcc-4.5.1.tar.bz2 <span class="token operator">\</span>
  &amp;&amp; wget https://www.python.org/ftp/python/3.6.5/Python-3.6.5.tar.xz</span>
  &amp;&amp; wget https://www.python.org/ftp/python/2.7.2/Python-2.7.2.tar.xz
  &amp;&amp; tar -xvf Python-2.7.2.tar.xz
  &amp;&amp; tar -xvf Python-3.6.5.tar.xz
  &amp;&amp; cd Python-2.7.2.tar.xz
  &amp;&amp; cd Python-3.6.5.tar.xz
  &amp;&amp; ./configure prefix=/usr/local/python3
</code></pre><p>发现无法处理中文，会出现编码问题。</p>
<ul>
<li>如果需要 Python23 共存的环境：在 Alpine 上安装 python23 版本共存的环境。</li>
</ul>
<pre data-role="codeBlock" data-info="DockerFile" class="language-dockerfile DockerFile"><code><span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> alpine:3.8</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> apk add --no-cache python <span class="token operator">\</span>
  &amp;&amp; python -m ensurepip <span class="token operator">\</span>
  &amp;&amp; rm -r /usr/lib/python*/ensurepip <span class="token operator">\</span>
  &amp;&amp; pip install --upgrade pip setuptools <span class="token operator">\</span>
  &amp;&amp; rm -r /root/.cache <span class="token operator">\</span>
  &amp;&amp; apk add --no-cache python3 <span class="token operator">\</span>
  &amp;&amp; rm -r /usr/lib/python*/ensurepip <span class="token operator">\</span>
  &amp;&amp; pip3 install --upgrade pip setuptools &amp;&amp; <span class="token operator">\</span>
  rm -r /root/.cache</span>
</code></pre><p>发现无法使用 locale 指令，仍然无法解决。最后，放弃 python2，使用 Ubuntu+Python3.6 环境：尝试在 dockerhub 上找到使用 ubuntu 系统、已经封装好的 Python 镜像<code>python:3.6.10-buster</code>。</p>
<pre data-role="codeBlock" data-info="DockerFile" class="language-dockerfile DockerFile"><code><span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> python:3.6.10-buster</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> apt-get update <span class="token operator">\</span>
      &amp;&amp; apt-get install wget locales</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> pip3 install numpy -i http://pypi.douban.com/simple/ --trusted-host pypi.douban.com</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> pip3 install scipy -i http://pypi.douban.com/simple/ --trusted-host pypi.douban.com</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> pip3 install numpy hanziconv pandas scipy blaze nltk snownlp -i http://pypi.douban.com/simple/ --trusted-host pypi.douban.com</span>
<span class="token comment">## pandas scipy scikit-learn</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> locale-gen zh_CN.UTF-8</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> chmod 0755 /etc/default/locale</span>
<span class="token instruction"><span class="token keyword keyword-ENV">ENV</span> LC_ALL=zh_CN.UTF-8</span>
<span class="token instruction"><span class="token keyword keyword-ENV">ENV</span> LANG=zh_CN.UTF-8</span>
<span class="token instruction"><span class="token keyword keyword-ENV">ENV</span> LANGUAGE=zh_CN.UTF-8</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> ln -fs /bin/bash /bin/sh</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span>  rm -rf /var/lib/apt/lists/*</span>
<span class="token instruction"><span class="token keyword keyword-CMD">CMD</span> [<span class="token string">"bash"</span>]</span>
</code></pre><pre data-role="codeBlock" data-info="Dockerfile" class="language-dockerfile Dockerfile"><code><span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> python3_ubuntu:v0.0.1</span>
<span class="token instruction"><span class="token keyword keyword-ENV">ENV</span> DEBIAN_FRONTEND = noninteractive</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> pip3 install numpy hanziconv pandas scipy blaze nltk snownlp -i http://pypi.douban.com/simple/ --trusted-host pypi.douban.com</span>
<span class="token instruction"><span class="token keyword keyword-CMD">CMD</span> [<span class="token string">"bash"</span>]</span>
</code></pre><h2 id="usage">Usage </h2>
<h3 id="引用头文件">引用头文件 </h3>
<p><code>#include &lt;Python.h&gt;</code><br>
最好不要用<code>#include &lt;pythonx.y/Python.h&gt;</code>这种形式，为了可移植性。<br>
调用 PYTHON 的 C API 时，必须引用这个头文件，由于有一些预处理的定义会影响标准库，所以必须优先于其他的标准头文件。<br>
如果编译时提示<code>no such file</code>，说明环境还有些问题。可参考 <a href="https://stackoverflow.com/questions/21530577/fatal-error-python-h-no-such-file-or-directory">stackoverflow</a><br>
或者像上文中， export 目标 path 即可。<br>
编译时可使用参数 -framework Python：<code>gcc(或g++) sample.cpp -o sample -framework Python</code></p>
<h2 id="常用函数">常用函数 </h2>
<h3 id="初始化">初始化 </h3>
<p><code>Py_Initialize()和Py_Finalize(void);</code>定义在 pylifecycle.h 中：</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token function">PyAPI_FUNC</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span> <span class="token function">Py_Initialize</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PyAPI_FUNC</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span> <span class="token function">Py_Finalize</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>用于初始化 Python 解释器、加载 sys.modules 还有些其他的功能。先调用这个函数，再调用其他 Python/C API 函数。如果是嵌套在类中，可以在构造函数或者写一个<code>init()</code>函数中调用<code>Py_Initialize()</code>，然后在西析构函数中调用<code>Py_Finalize()</code>。<br>
以下三个函数也定义在 pylifecycle.h 中。如果需要处理中文，遇到<code>wchar_t*</code>变量的时候，可以用 <code>Py_DecodeLocale()</code> 做编码转换。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token function">PyAPI_FUNC</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span> <span class="token function">Py_SetProgramName</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-wchar_t">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PyAPI_FUNC</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span> <span class="token function">Py_SetPythonHome</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-wchar_t">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PyAPI_FUNC</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span>      <span class="token function">Py_SetPath</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-wchar_t">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>这三个函数应先于 Initialize()调用。<br>
如果遇到：<code>Fatal Python error: Py_Initialize: Unable to get the locale encoding</code><br>
把前面的三个设置去掉就可以了。</p>
<h3 id="线程相关">线程相关 </h3>
<h4 id="gil">GIL </h4>
<ol>
<li><code>PyGILState_STATE PyGILState_Ensure()</code><br>
确保当前线程准备好调用 CAPI，可以跳过当前 python 的状态和 GIL 锁。</li>
<li><code>void PyGILState_Release(PyGILState_STATE)</code>函数：<br>
释放当前获取的所有资源，调用后，Python 状态将保持不变。</li>
<li><code>int PyGILState_Check()</code>如果当前线程拥有 GIL 锁，返回 1。<br>
可以封装在类中，避免忘记手动销毁。</li>
</ol>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">EnsureGilState</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">EnsureGilState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _state <span class="token operator">=</span> <span class="token function">PyGILState_Ensure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">EnsureGilState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PyGILState_Release</span><span class="token punctuation">(</span>_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword keyword-private">private</span><span class="token operator">:</span>
    PyGILState_STATE _state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="多线程">多线程 </h4>
<ol>
<li><code>PyThreadState</code>对象，记录 Python 线程状态。</li>
<li><code>PyThreadState* PyEval_SaveThread()</code>如果 GIL 锁已经创建，并且将线程状态变成 NULL，释放 GIL 锁。</li>
<li><code>void PyEval_RestoreThread(PyThreadState *tstate)</code></li>
<li><code>PyEval_InitThreads();</code>初始化并且获取 GIL 锁。应该在主线程调用，在调用其他线程之前。</li>
</ol>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">EnableThreads</span> <span class="token punctuation">{</span>
<span class="token keyword keyword-public">public</span><span class="token operator">:</span>
    <span class="token function">EnableThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _state <span class="token operator">=</span> <span class="token function">PyEval_SaveThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">EnableThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PyEval_RestoreThread</span><span class="token punctuation">(</span>_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword keyword-private">private</span><span class="token operator">:</span>
    PyThreadState<span class="token operator">*</span> _state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="运行-python-脚本">运行 python 脚本 </h3>
<p><code>PyRun_SimpleString()</code>函数用来运行脚本，定义在<code>pythonrun.h</code>中。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token function">PyAPI_FUNC</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span><span class="token punctuation">)</span> <span class="token function">PyRun_SimpleStringFlags</span><span class="token punctuation">(</span><span class="token keyword keyword-const">const</span> <span class="token keyword keyword-char">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> PyCompilerFlags <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
## define <span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token function">PyRun_SimpleStringFlags</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
</code></pre><p>比如</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import sys"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// or</span>
<span class="token function">PyRun_SimpleString</span><span class="token punctuation">(</span><span class="token string">"import sys;import csv;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="模块导入">模块导入 </h3>
<p><code>PyImport_ImportModule</code>定义在<code>import.h</code></p>
<pre data-role="codeBlock" data-info="C++" class="language-cpp C++"><code><span class="token function">PyAPI_FUNC</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">PyImport_ImportModule</span><span class="token punctuation">(</span>
     <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-char">char</span> <span class="token operator">*</span>name            <span class="token comment">/* UTF-8 encoded string */</span>
     <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>eg: 写一个 test_add.py（这里写在了同目录下）</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> t_str<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>t_str <span class="token operator">==</span> <span class="token string">""</span> <span class="token keyword keyword-or">or</span> t_str <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> func_1<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> func_2<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>t_str<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-def">def</span> <span class="token function">func_1</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> a<span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword keyword-def">def</span> <span class="token function">func_2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> a<span class="token operator">+</span>b
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>然后调用</p>
<pre data-role="codeBlock" data-info="C++" class="language-cpp C++"><code>std<span class="token double-colon punctuation">::</span>string module_name <span class="token operator">=</span> <span class="token string">"test_add"</span><span class="token punctuation">;</span> <span class="token comment">// test_add.py</span>
PyObject<span class="token operator">*</span> pModule <span class="token operator">=</span> <span class="token function">PyImport_ImportModule</span><span class="token punctuation">(</span>module_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>ps: 其中遇到个问题：<code>Undefined symbols for architecture x86_64 ，后面是__basic_string blah blah</code>，把 gcc 改成 g++解决。（clang 同理） *注意，只获得 pModule，未必会成功。不成功的原因可能有以下几种：</p>
<ol>
<li>名字不对，比如用 main/test 这类名字；</li>
<li>脚本内有错误：这种情况想要排查的话，使用 PyErr_Print()即可。<br>
所以，要在获取 pModule 之后加 check，否则容易引起后续的很多未知问题。</li>
</ol>
<pre data-role="codeBlock" data-info="C++" class="language-cpp C++"><code><span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_pModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PyErr_Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Fatal"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>python 的 C API 有一些关于异常的处理，后面详细讲。</p>
<h3 id="获取-py-脚本中的函数对象">获取 py 脚本中的函数对象 </h3>
<p><code>PyObject_GetAttrString()</code><br>
例如：</p>
<pre data-role="codeBlock" data-info="C++" class="language-cpp C++"><code>PyObject<span class="token operator">*</span> pTestFunc <span class="token operator">=</span> <span class="token function">PyObject_GetAttrString</span><span class="token punctuation">(</span>pModule<span class="token punctuation">,</span> <span class="token string">"func"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 同上，为了安全，加一个check。</span>
<span class="token keyword keyword-if">if</span>（<span class="token operator">!</span><span class="token function">PyCallable_Check</span><span class="token punctuation">(</span>pTestFunc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">PyErr_Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Fatal: not callable"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="构建输入对象">构建输入对象 </h3>
<p><code>PyTuple_SetItem()</code><br>
在上面的脚本中，调用 <code>func</code> 可能有两种执行结果：如果第二个参数是空或者 None，则调用 func_1，否则调用 func_2。<br>
比如，需要把一个值，或者两个值输入到 py 脚本的 func 函数中。这里的<code>num</code>是一个参数，按奇数偶数采取不同的含参数。</p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>PyObject<span class="token operator">*</span> args <span class="token operator">=</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">;</span>
PyObject<span class="token operator">*</span> arg1 <span class="token operator">=</span> <span class="token function">PyInt_FromLong</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    args <span class="token operator">=</span> <span class="token function">PyTuple_New</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string test_str <span class="token operator">=</span> <span class="token string">"20"</span><span class="token punctuation">;</span>
    PyObject<span class="token operator">*</span> arg2 <span class="token operator">=</span> <span class="token function">Py_BuildValue</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span> test_str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
    args <span class="token operator">=</span> <span class="token function">PyTuple_New</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PyTuple_SetItem</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>Py_BuildValue(X, Y)</code>这个函数，参数 X 为格式字符串，代表属性的类型。一般有"s" "i"等等。可参考<a href="https://docs.python.org/release/1.5.2p2/ext/parseTuple.html">这里</a>。</p>
<h3 id="构建输出对象">构建输出对象 </h3>
<p><code>PyObject_CallObject()</code></p>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code>PyObject<span class="token operator">*</span> pRet <span class="token operator">=</span> <span class="token function">PyObject_CallObject</span><span class="token punctuation">(</span>pFunc<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="获取结果">获取结果 </h3>
<pre data-role="codeBlock" data-info="c++" class="language-cpp c++"><code><span class="token keyword keyword-int">int</span> iRet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">PyArg_Parse</span><span class="token punctuation">(</span>pRet<span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> iRet <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>pRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><code>Py_XDECREF</code>用来对引用计数执行减一操作。与<code>Py_DECREF</code>的区别是：会对 NULL 进行处理。<br>
如果不执行减一操作，很可能会发生内存泄露。</p>
<h3 id="错误和异常处理">错误和异常处理 </h3>
<p><code>PyErr_Print();</code>如果调用之前发生错误，则会发出一些错误信息。<br>
清除错误信息：<code>PyErr_Clear();</code><br>
在调试多线程时，发现 PyErr_Print()不能正常调用。如果需要打印 python 脚本的报错信息，可以用 traceback 记录的内容。</p>
<pre data-role="codeBlock" data-info="C++" class="language-cpp C++"><code><span class="token keyword keyword-void">void</span> <span class="token function">print_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    PyObject<span class="token operator">*</span> ex <span class="token operator">=</span> <span class="token function">PyErr_Occurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PYObject <span class="token operator">*</span>ptype<span class="token punctuation">,</span> <span class="token operator">*</span>pvalue<span class="token punctuation">,</span> <span class="token operator">*</span>ptraceback<span class="token punctuation">;</span>
    <span class="token function">PyErr_Fetch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pvalue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ptraceback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PyTracebackObject<span class="token operator">*</span> tb <span class="token operator">=</span> <span class="token punctuation">(</span>PyTracebackObject <span class="token operator">*</span><span class="token punctuation">)</span>ptraceback<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Traceback: "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>tb <span class="token operator">!=</span> <span class="token keyword keyword-nullptr">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PyObject <span class="token operator">*</span>line <span class="token operator">=</span> <span class="token function">PyUnicode_FromFormat</span><span class="token punctuation">(</span><span class="token string">"File \"%U\", line %d, in %U\n"</span><span class="token punctuation">,</span>
            tb<span class="token operator">-&gt;</span>tb_frame<span class="token operator">-&gt;</span>f_code<span class="token operator">-&gt;</span>co_filename<span class="token punctuation">,</span> tb<span class="token operator">-&gt;</span>tb_lineno<span class="token punctuation">,</span> tb<span class="token operator">-&gt;</span>tb_frame<span class="token operator">-&gt;</span>f_code<span class="token operator">-&gt;</span>co_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">PyUnicode_1BYTE_DATA</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tb <span class="token operator">=</span> tb<span class="token operator">-&gt;</span>tb_next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    PyObject<span class="token operator">*</span> ptypeStr <span class="token operator">=</span> <span class="token function">PyObject_Str</span><span class="token punctuation">(</span>ptype<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyObject<span class="token operator">*</span> pvalueStr <span class="token operator">=</span> <span class="token function">PyObject_Str</span><span class="token punctuation">(</span>pvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ERROR IS"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>pvalueStr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ERROR TYPE"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>ptypeStr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="内存相关">内存相关 </h2>
<h3 id="引用计数">引用计数 </h3>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-void">void</span> <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-void">void</span> <span class="token function">Py_CLEAR</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>o<span class="token punctuation">)</span>
</code></pre><p>引用计数用于内存管理，可以统计对象被引用了多少次并且给出一些处理。当引用计数为 0 的时候，将执行 deallcoate 操作（对象中的一个函数指针）。除了可以控制内存以外，还可以帮助判断一个对象是否存在。如果引用计数大于 0，那么说明对象的生存周期还没有结束。</p>
<p>关于引用计数的变化情况，文档中是这样介绍的：</p>
<blockquote>
<p>In theory, the object’s reference count goes up by one when the variable is made to point to it and it goes down by one when the variable goes out of scope.</p>
</blockquote>
<p>Ownership of reference: 这里的“所有权”，意味着有权限执行 Py_DECREF。</p>
<p>传递对象的引用给函数的时候有两种情形：可能“偷走”引用或者不。“偷走”引用意味着当传递引用给函数的时候，函数假设其“拥有”了引用。比如<code>PyList_SetItem()</code> 和 <code>PyTuple_SetItem()</code></p>
<p><code>Py_INCREF(PyObject *o);</code><br>
增加引用计数</p>
<p>文档中关于安全性的一些建议：</p>
<blockquote>
<p>A safe approach is to always use the generic operations (functions whose name begins with <code>PyObject*, PyNumber*, PySequence* or PyMapping*</code>). These operations always increment the reference count of the object they return.</p>
</blockquote>
<p>但是实际测试中，发现内存泄漏的情况还是很严重，而且很难定位。后来妥协了，采用了 pybind 这个库，是在 python CAPI 之上进行了一层封装，这个库比 Python C API 更友好。</p>
<p><a href="https://github.com/pybind/pybind11">https://github.com/pybind/pybind11</a></p>
<h2 id="reference">Reference </h2>
<p><a href="https://docs.python.org/3.6/c-api/index.html">https://docs.python.org/3.6/c-api/index.html</a><br>
<a href="https://docs.python.org/3/c-api/memory.html">https://docs.python.org/3/c-api/memory.html</a><br>
<a href="ftp://ftp.netapp.com/frm-ntap/opensource/ClusterViewer/1.0/package_sources/Python-3.4.4/Include/">ftp://ftp.netapp.com/frm-ntap/opensource/ClusterViewer/1.0/package_sources/Python-3.4.4/Include/</a><br>
<a href="https://www.medin.name/blog/2012/02/12/embedding-python-inside-a-multithreaded-c-program/">https://www.medin.name/blog/2012/02/12/embedding-python-inside-a-multithreaded-c-program/</a></p>

      </div>
      <div class="md-sidebar-toc">
<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#python-capi-的简单使用" class="md-toc-link"><p>Python CAPI 的简单使用</p>
</a>
          </summary>
        <div>
          <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#环境配置" class="md-toc-link"><p>环境配置</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#编译环境" class="md-toc-link">
            <p>编译环境</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#docker-镜像封装" class="md-toc-link">
            <p>Docker 镜像封装</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#usage" class="md-toc-link"><p>Usage</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#引用头文件" class="md-toc-link">
            <p>引用头文件</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#常用函数" class="md-toc-link"><p>常用函数</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#初始化" class="md-toc-link">
            <p>初始化</p>

          </a></div><details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#线程相关" class="md-toc-link"><p>线程相关</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#gil" class="md-toc-link">
            <p>GIL</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#多线程" class="md-toc-link">
            <p>多线程</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#运行-python-脚本" class="md-toc-link">
            <p>运行 python 脚本</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#模块导入" class="md-toc-link">
            <p>模块导入</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#获取-py-脚本中的函数对象" class="md-toc-link">
            <p>获取 py 脚本中的函数对象</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#构建输入对象" class="md-toc-link">
            <p>构建输入对象</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#构建输出对象" class="md-toc-link">
            <p>构建输出对象</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#获取结果" class="md-toc-link">
            <p>获取结果</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#错误和异常处理" class="md-toc-link">
            <p>错误和异常处理</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:24px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#内存相关" class="md-toc-link"><p>内存相关</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#引用计数" class="md-toc-link">
            <p>引用计数</p>

          </a></div>
        </div>
      </details>
    <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#reference" class="md-toc-link">
            <p>Reference</p>

          </a></div>
        </div>
      </details>
    
</div>
</div>
      <a id="sidebar-toc-btn">≡</a>
    
    
    
    
    
    
<script>
document.body.setAttribute('html-show-sidebar-toc', true)
var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  
    </body></html>